
	
	
    
        
	<div id="wrapper" class="wrapper">
        
	</div>
	
    <div class="shareNews" id="shareNews">
           
    </div>        	
    <script src="~/Scripts/jquery-2.1.1.js"></script>
    
    <script src="~/Scripts/OpenLayers.js" type="text/javascript"></script> 
    <script>
        
        
       
        
        function getHotNewsFromFile() {
            //alert('ok');
            var request = OpenLayers.Request.GET({
                url: "/Title/getDetail",
                params: { tokenid: '@ViewBag.tokenid' },
                callback: function (data) {
                    var news = '{"news":' + data.responseText + '}';
                    var json_parsed = $.parseJSON(news);
                    var j = 0;
                    var diff=0;
                    var today = new Date();
                    var str_time;
                    //alert(json_parsed.news.length);
                    for (var i = 0; i < json_parsed.news.length; i++) {
                        if (json_parsed.news[i]) {
                            var n = json_parsed.news[i];
                            if (n.name != null && n.name != "") {
                             
                                //try{
                                //    diff = getMinuteDiff(new Date(n.datetime), today);
                                //    if (diff > 60) 
                                //        str_time = "Cập nhật " + Math.round(diff / 60) + " giờ trước";
                                //    else
                                //        str_time = "Cập nhật " + diff+ " phút trước";
                                //} catch (err) {
                                //    diff = 0;
                                //}
                                var content = "";
                                var comment = "<fb:comments class=\"fb-comments\" href=\"http://localhost:50735/Title/getTitle?tokenid=" + n.tokenid + "\" data-num-posts=\"2\" data-width=\"440\"  notify=\"true\"  migrated=\"1\"></fb:comments>";
                                    //"<fb:comments notify=\"true\"   num_posts=\"3\" width=\"630\"></fb:comments>";
                                //comment = "<div class=\"fb-comments\" ></div>";
                                var formComment = '<br><div id=\"dvComment\"></div><input type=\"text\" value=\"\" id=\"cmtContent\"><input type=\"button\" value=\"Bình Luận\" onclick=\"updateComment(\'' + n.tokenid + '\')\"><br>';
                                content += "<Table><tr><td class=detail><a href=\"" + n.link + "\" class=title>" + n.name + "</a><br>" + n.des + "<br>" + formComment + "</td></tr></table><br>";
                                //alert(content);
                                //alert(comment);
                                $('#wrapper').append(content);
                                getNewsComment(n.tokenid);
                               
                            }
                        }
                    }
                }
            });
        }
        getHotNewsFromFile();
        function getMinuteDiff(date1, date2) {
            try{
                //Get 1 day in milliseconds
                var one_minute=1000*60;
                //alert(date1 + "-" + date2);
                var a = new Date(date1);
                var b = new Date(date2);
                //alert(a + "-" + b);
                // Convert both dates to milliseconds
                var date1_ms = a.getTime();
                var date2_ms = b.getTime();
                //alert(date1_ms + "-" + date2_ms);
                //return 2;
                // Calculate the difference in milliseconds
                var difference_ms = date2_ms - date1_ms;
                //alert(difference_ms);
                //return difference_ms;
                // Convert back to days and return
                return Math.round(difference_ms / one_minute);
            }catch(err){
                return 0;
            }
        }
        var checkFlushBig;
        function updateComment(token) {
            var isLogin='@ViewBag.userToken';
            if (isLogin == '') {
                alert("Bạn phải đăng ký làm thành viên để bình luận tin tức!");
                window.location = "/Account/Login";
                return;
            }
            if (document.getElementById("cmtContent").value == "") {
                alert("Nhập nội dung!");
                return;
            }
            var lenDomain = 0;
            var formdata = new FormData(); //FormData object
            formdata.append("contents", document.getElementById("cmtContent").value);
            formdata.append("token", token);
            formdata.append("usertoken", '@ViewBag.userToken');
            //Creating an XMLHttpRequest and sending
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/comment/InsertComment');
                xhr.send(formdata);
                xhr.onreadystatechange = function () {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        //alert(xhr.responseText);
                        //$('#UploadTarget').html(xhr.responseText);
                        //$('#dv' + token).append('<br><@ViewBag.userToken>:' + document.getElementById("cmt" + token).value + '<br>');
                        //alert('Co comment nhe1' + token+','+document.getElementById("cmt" + token).value);
                        chat.server.joinRoom("Comment", document.getElementById("cmtContent").value);
                        //alert('Co comment nhe2');
                    }
                }
                xhr.onprogress = function () {
                    //document.getElementById('process').innerHTML = 'value' + e.loaded + "/" + e.total;
                }
                return false;

            }
        function getNewsComment(token) {
             
            var request = OpenLayers.Request.GET({
                url: "/comment/getNewsComment",
                params: { linktoken: token },
                callback: function (data) {
                    var news = '{"news":' + data.responseText + '}';
                    var json_parsed = $.parseJSON(news);
                    //alert(news);
                    var diff = 0;
                    var today = new Date();
                    //alert(today);
                    var str_time;

                    for (var i = json_parsed.news.length; i >= 0; i--) {
                        if (json_parsed.news[i]) {
                            var n = json_parsed.news[i];
                            //alert(n.datetime);
                            try{
                                diff = getMinuteDiff(new Date(n.datetime).toUTCString(), today.toUTCString());
                                if (diff > 60) 
                                    str_time = " gửi " + Math.round(diff / 60) + " giờ trước";
                                else
                                    str_time = " gửi " + diff+ " phút trước";
                            } catch (err) {
                                diff = 0;
                            }

                            //alert(n.id + ')' + n.fullName + ':' + n.contents + '(' + n.datetime + ')<br>');
                            $('#dvComment').append(n.id + ')' + n.fullName + ':' + n.contents + '(' + str_time + ')<br>');
                        }
                    }
                }
            });
        }
    </script>
    <div class="noticebox" id="noticebox" style="display:block"></div>
    
    <script src="~/Scripts/jquery.signalR-1.1.3.min.js"></script>        
    <script src="~/signalR/hubs"></script>
    <script>
        var chat = $.connection.ync;
        
        $(function () {
            
            chat.client.addNewAll = function (token, message) {
                //$('#' + group).append('<li>' + message + '</li>');
                alert("ok");
                if (message != "") {
                    //$('#dv' + token).append('<li>' + message + '</li>');
                    document.getElementById("noticebox").style.display = '';
                    $('#noticebox').append('Có bình luận mới:' + message);
                }
            };            
            chat.client.addChatMessage = function (group, message) {
                //alert(message);
                if (message != "") {
                    $('#dvComment').append('<B>@ViewBag.userFullName:</B>' + message + '</li>');
                    document.getElementById("noticebox").style.display = '';
                    $('#noticebox').append('Có bình luận mới:' + message);
                }
            };
            $.connection.hub.start().done(function () {
                //alert("ok22");
                
            });
        });
    </script>        

