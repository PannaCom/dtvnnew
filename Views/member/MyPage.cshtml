@model youknow.Views.ModelClassViewMyPage
@{
    ViewBag.Title = "Trang cá nhân";
    Layout = "~/Views/Shared/_Layout.cshtml";
    string title="";
    string titleNoMark = "";
    string des="";
    string content = "";
    int? totalComments = 0;    
}
<div style="width:100%;position:relative;float:left;">  
    <div style="width:90%;position:relative;float:left;"><a href="/member/Edit/@Session["userid"]" style="text-decoration:none;">Đổi tên sử dụng trên Điểm Tin Việt Nam</a><br/></div>
    @if (ViewBag.err==0)
    {
        foreach (youknow.Views.viewMyPageManager item in Model.ieViewMyPage)
        {        
            title = System.Web.HttpUtility.HtmlDecode(item.title);
            titleNoMark=youknow.Uti.unicodeToNoMark(title);
            content += "<div style=\"width:90%;position:relative;float:left;\"><div style=\"width:80%;position:relative;float:left;\"><a class=\"inforTinFont2\" style=\"cursor:pointer;text-decoration:none;\" href=\"/comment/readNews/" + item.idnews + "/" + titleNoMark + "\">" + title + "</a></div><div style=\"width:80%;position:relative;float:left;\"><span class=\"desFont\"><i>đã viết..." + Html.Raw(item.contents) + "</i></span></div></div>";
        }
    }
    <div style="width:90%;position:relative;float:left;"><span class="u" id="totalComments"></span></div>
    <div style="width:90%;position:relative;float:left;">
        <a class="inforTinFont2">
            Bình luận gần đây:<br/> 
        </a>
    </div>
    <div style="width:90%;position:relative;float:left;">
        @Html.Raw(content)
    </div>
</div>
<script src="~/Scripts/jquery-2.1.1.js"></script>
    <script src="~/Scripts/core.js" type="text/javascript"></script> 
    <script src="~/Scripts/OpenLayers.js" type="text/javascript"></script> 
    <script>
        getTotalComments();
        function getTotalComments() {
            //Creating an XMLHttpRequest and sending
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/member/getTotalComments');
            xhr.send();
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                        document.getElementById("totalComments").innerHTML = "Tổng số bài bình luận: "+xhr.responseText;
                }
            }

        }
        function getMinuteDiff(date1, date2) {
            try{
                //Get 1 day in milliseconds
                var one_minute=1000*60;
                //alert(date1 + "-" + date2);
                var a = new Date(date1);
                var b = new Date(date2);
                //alert(a + "-" + b);
                // Convert both dates to milliseconds
                var date1_ms = a.getTime();
                var date2_ms = b.getTime();
                //alert(date1_ms + "-" + date2_ms);
                //return 2;
                // Calculate the difference in milliseconds
                var difference_ms = date2_ms - date1_ms;
                //alert(difference_ms);
                //return difference_ms;
                // Convert back to days and return
                return Math.round(difference_ms / one_minute);
            }catch(err){
                return 0;
            }
        }
        
        function showTimeComment(dateComment){
            var diff = 0;
            var today = new Date();
            var str_time="gần đây";
            try{
                diff = getMinuteDiff(new Date(dateComment).toUTCString(), today.toUTCString());
                if (diff > 60) 
                    str_time = " gửi " + Math.round(diff / 60) + " giờ trước";
                else
                    str_time = " gửi " + diff+ " phút trước";
            } catch (err) {
                diff = 0;
            }
            return str_time;
        }
        
    </script>
    
    
    <script src="~/Scripts/jquery.signalR-1.1.3.min.js"></script>        
    <script src="~/signalR/hubs"></script>
    <script>
        var chat = $.connection.ync;
        
        $(function () {
            
            chat.client.addNewAll = function (token, message) {
                //$('#' + group).append('<li>' + message + '</li>');
                alert("ok");
                if (message != "") {
                    //$('#dv' + token).append('<li>' + message + '</li>');
                    document.getElementById("noticebox").style.display = '';
                    $('#noticebox').append('Có bình luận mới:' + message);
                }
            };            
            chat.client.addChatMessage = function (roomName, username, usertoken, contents, token, link, title) {
                //alert(contents);
                if (contents != "") {
                    //$('#dvComment').append('<br>' + username + ': ' + contents + '</br>');
                    document.getElementById("realtimeComment").style.display = '';
                    $('#realtimeComment').append(username + ' bình luận: <i>' + contents + '</i> tại tin tức:<a href=\'..\\..\\comment\\readNews?linktoken=' + token + '\'>' + title + '</a><br>');
                }
            };
            $.connection.hub.start().done(function () {
                chat.server.joinRoom("Comment", '','','','','','');
                
            });
        });
        
    </script>   