@model youknow.Models.userFilter

@{
    ViewBag.Title = "Create";
}

<h2>Create</h2>

@using (Html.BeginForm()) {
    @Html.AntiForgeryToken()
    @Html.ValidationSummary(true)

    <fieldset>
        <legend>userFilter</legend>

        Source News<div id="groupDomain"></div>
        Topic News<div id="groupCat"></div>
        <p>
            <input type="button" value="Save" onclick="update();"/>
        </p>
    </fieldset>
}

<div>
    @Html.ActionLink("Back to List", "Index")
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script src="~/Scripts/OpenLayers.js" type="text/javascript"></script> 
    <script>
        var request = OpenLayers.Request.GET({
                url: "/userFilter/getDomain",                
            callback: function (data) {
                var news = '{"news":' + data.responseText + '}';
                $("#groupDomain").html('');
                var json_parsed = $.parseJSON(news);
                for (var i = 0; i < json_parsed.news.length; i++) {
                    if (json_parsed.news[i]) {
                        var n = json_parsed.news[i];
                        $("#groupDomain").append('<input type=checkbox id=\"chkDomain\" name=\"chkDomain\" value=\"' + n.id + '\">' + n.name);                        
                    }
                }
                getCategory();
            }
        });
        function getCategory() {
            
            request = OpenLayers.Request.GET({
                url: "/userFilter/getCategory",
                callback: function (data) {
                    var news = '{"news":' + data.responseText + '}';
                    $("#groupCat").html('');
                    
                    var json_parsed = $.parseJSON(news);
                    for (var i = 0; i < json_parsed.news.length; i++) {
                        if (json_parsed.news[i]) {
                            var n = json_parsed.news[i];
                            $("#groupCat").append('<input type=checkbox name=\"chkCat\" value=\"' + n.id + '\">' + n.name);                            
                        }
                    }
                    getUserEdit();
                }
            });
        }
        function getUserEdit() {
            request = OpenLayers.Request.GET({
                url: "/userFilter/getUserFilterEdit",
                callback: function (data) {
                    var news = '{"news":' + data.responseText + '}';                    
                    var json_parsed = $.parseJSON(news);
                    for (var i = 0; i < json_parsed.news.length; i++) {
                        if (json_parsed.news[i]) {
                            var n = json_parsed.news[i];
                            //alert(n.domain + ',' + n.catid);
                            $('input[type="checkbox"]').each(function () {
                                //alert($(this).attr("name") + ',value=' + $(this).val());
                                if ($(this).attr("name") == 'chkDomain') {
                                    //alert('domain='+n.domain + ',this'+$(this).attr("name")+' value='+$(this).val());
                                    if (n.domain != null && n.domain == $(this).val()) {
                                        $(this).attr('checked', 'checked');
                                        //alert('ok1');
                                    }
                                }
                                if ($(this).attr("name") == 'chkCat') {
                                    //alert('catid=' + n.catid + ',this' + $(this).attr("name") + ' value=' + $(this).val());
                                    if (n.catid != null && n.catid == $(this).val()) {
                                        $(this).attr('checked', 'checked');
                                        //alert('ok2');
                                    }
                                }
                            });
                        }
                    }
                }
            });
        }
        
        function update() {
            var lenDomain=0;
            var formdata = new FormData(); //FormData object
            //alert("ok");
            $('input[type="checkbox"]:checked').each(function () {
                // add $(this).val() to your array
                //alert($(this).attr("name"));
                if ($(this).attr("name") == 'chkDomain') {
                    formdata.append("domainId" + lenDomain, $(this).val());
                    lenDomain++;
                    //alert(lenDomain);
                }
                if ($(this).attr("name") == 'chkCat') {
                    formdata.append("catId" + lenDomain, $(this).val());
                    lenDomain++;
                    //alert("catId" + $(this).val());
                }
            });            
            //Creating an XMLHttpRequest and sending
            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/userFilter/updateDomainUserFilter');
            xhr.send(formdata);
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    //alert(xhr.responseText);
                    //$('#UploadTarget').html(xhr.responseText);
                    window.location = "/userFilter/Index";
                }
            }
            xhr.onprogress = function () {
                //document.getElementById('process').innerHTML = 'value' + e.loaded + "/" + e.total;
            }
            return false;
        }

    </script>
}
